name: ğŸ” ã†ã¡ã®ãã‚ã ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ 

on:
  schedule:
    # æ¯5åˆ†å®Ÿè¡Œ
    - cron: '*/5 * * * *'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  
env:
  SITE_URL: 'https://uchinokiroku.com'
  VPS_HOST: '160.251.136.92'
  VPS_USER: 'root'

jobs:
  health-monitoring:
    name: ğŸ” ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç›£è¦–
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ” Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          cat > ~/.ssh/config << EOF
          Host vps
            HostName ${{ env.VPS_HOST }}
            User ${{ env.VPS_USER }}
            IdentityFile ~/.ssh/id_rsa
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          EOF
          chmod 600 ~/.ssh/config

      - name: ğŸŒ Webã‚µã‚¤ãƒˆå¿œç­”ãƒã‚§ãƒƒã‚¯
        id: website_check
        run: |
          echo "ğŸ” Checking website response..."
          if curl -f -s --max-time 15 "${{ env.SITE_URL }}" > /dev/null; then
            echo "âœ… Website: Responding"
            echo "website_status=ok" >> $GITHUB_OUTPUT
          else
            echo "âŒ Website: Not responding"
            echo "website_status=failed" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        id: db_check
        run: |
          echo "ğŸ” Checking database health..."
          if curl -f -s --max-time 10 "${{ env.SITE_URL }}/api/health/db" > /dev/null; then
            echo "âœ… Database: Healthy"
            echo "db_status=ok" >> $GITHUB_OUTPUT
          else
            echo "âŒ Database: Unhealthy"
            echo "db_status=failed" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ” èªè¨¼APIãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        id: auth_check
        run: |
          echo "ğŸ” Checking authentication API..."
          if curl -f -s --max-time 10 "${{ env.SITE_URL }}/api/health/auth" > /dev/null; then
            echo "âœ… Auth API: Healthy"
            echo "auth_status=ok" >> $GITHUB_OUTPUT
          else
            echo "âŒ Auth API: Unhealthy"
            echo "auth_status=failed" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ–¥ï¸ VPSã‚·ã‚¹ãƒ†ãƒ ç›£è¦–
        id: vps_check
        run: |
          echo "ğŸ” Checking VPS system status..."
          
          ssh vps << 'MONITOR_EOF'
            echo "ğŸ“Š VPS System Status:"
            
            # ãƒ—ãƒ­ã‚»ã‚¹ç¢ºèª
            if pgrep -f "next-server|npm.*dev|node.*next" > /dev/null; then
              echo "âœ… Next.js Process: Running"
              echo "process_status=ok"
            else
              echo "âŒ Next.js Process: Not found"
              echo "process_status=failed"
            fi
            
            # ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡
            disk_usage=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
            echo "ğŸ’¾ Disk Usage: ${disk_usage}%"
            
            # ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡
            memory_usage=$(free | awk 'NR==2{printf "%.0f", $3*100/$2 }')
            echo "ğŸ§  Memory Usage: ${memory_usage}%"
            
            # ãƒ­ãƒ¼ãƒ‰ã‚¢ãƒ™ãƒ¬ãƒ¼ã‚¸
            load_avg=$(uptime | awk -F'load average:' '{print $2}')
            echo "âš–ï¸ Load Average:${load_avg}"
            
          MONITOR_EOF

      - name: ğŸ“Š ç›£è¦–çµæœã‚µãƒãƒªãƒ¼
        run: |
          echo "ğŸ” Health Check Summary:"
          echo "Website: ${{ steps.website_check.outputs.website_status }}"
          echo "Database: ${{ steps.db_check.outputs.db_status }}"
          echo "Auth API: ${{ steps.auth_check.outputs.auth_status }}"
          
          # å¤±æ•—ã‚«ã‚¦ãƒ³ãƒˆ
          failures=0
          [ "${{ steps.website_check.outputs.website_status }}" = "failed" ] && ((failures++))
          [ "${{ steps.db_check.outputs.db_status }}" = "failed" ] && ((failures++))
          [ "${{ steps.auth_check.outputs.auth_status }}" = "failed" ] && ((failures++))
          
          if [ $failures -eq 0 ]; then
            echo "ğŸ‰ All systems operational!"
          else
            echo "âš ï¸ $failures system(s) have issues"
          fi

      - name: ğŸš¨ ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥ (å¤±æ•—æ™‚)
        if: |
          steps.website_check.outputs.website_status == 'failed' ||
          steps.db_check.outputs.db_status == 'failed' ||
          steps.auth_check.outputs.auth_status == 'failed'
        run: |
          echo "ğŸš¨ ALERT: System issues detected!"
          echo "Website: ${{ steps.website_check.outputs.website_status }}"
          echo "Database: ${{ steps.db_check.outputs.db_status }}"
          echo "Auth API: ${{ steps.auth_check.outputs.auth_status }}"
          echo "Timestamp: $(date)"
          
          # TODO: Slack/ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã®å®Ÿè£…
          echo "Alert logged - notification system to be implemented"

  performance-monitoring:
    name: ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'  # æ‰‹å‹•å®Ÿè¡Œæ™‚ã®ã¿
    
    steps:
      - name: ğŸš€ ã‚µã‚¤ãƒˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
        run: |
          echo "ğŸ“ˆ Running performance tests..."
          
          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“æ¸¬å®š
          response_time=$(curl -o /dev/null -s -w '%{time_total}' "${{ env.SITE_URL }}")
          echo "â±ï¸ Response Time: ${response_time}s"
          
          # ãƒ˜ãƒ«ã‚¹API ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“
          health_time=$(curl -o /dev/null -s -w '%{time_total}' "${{ env.SITE_URL }}/api/health")
          echo "ğŸ¥ Health API Time: ${health_time}s"
          
          # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ¤å®š
          if (( $(echo "$response_time < 3.0" | bc -l) )); then
            echo "âœ… Performance: Good (< 3s)"
          elif (( $(echo "$response_time < 5.0" | bc -l) )); then
            echo "âš ï¸ Performance: Acceptable (3-5s)"
          else
            echo "âŒ Performance: Poor (> 5s)"
          fi