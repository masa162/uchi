name: üöÄ „ÅÜ„Å°„ÅÆ„Åç„Çç„Åè Simple Deploy

on:
  workflow_dispatch:  # ÊâãÂãïÂÆüË°åÂ∞ÇÁî®
  
env:
  VPS_HOST: '160.251.136.92'
  VPS_USER: 'root'
  APP_PATH: '/var/www/uchi'

jobs:
  simple-deploy:
    name: üöÄ Simple Deploy to VPS
    runs-on: ubuntu-latest
    
    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v4
        
      - name: üîê Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          cat > ~/.ssh/config << EOF
          Host vps
            HostName ${{ env.VPS_HOST }}
            User ${{ env.VPS_USER }}
            IdentityFile ~/.ssh/id_rsa
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          EOF
          chmod 600 ~/.ssh/config
          
      - name: üöÄ Simple Deploy
        run: |
          echo "üöÄ Starting simple deployment..."
          
          ssh vps << 'DEPLOY_EOF'
            echo "üìÅ Navigating to app directory..."
            cd /var/www/uchi
            
            echo "üîÑ Updating code..."
            git pull origin main
            
            echo "üì¶ Installing dependencies..."
            npm ci --only=production
            
            echo "üèóÔ∏è Building application..."
            npm run build
            
            echo "üßπ Stopping old processes..."
            pkill -f next || echo "No processes to stop"
            
            echo "üöÄ Starting application..."
            nohup ./start-with-env.sh > deploy.log 2>&1 &
            
            echo "‚úÖ Deployment completed!"
            sleep 5
            
            echo "üìä Status check:"
            ps aux | grep -E "(next|npm)" | grep -v grep || echo "No processes running"
          DEPLOY_EOF
          
      - name: ‚úÖ Health check
        run: |
          echo "‚úÖ Performing health check..."
          sleep 10
          if curl -f -s https://uchinokiroku.com > /dev/null; then
            echo "‚úÖ Site is responding"
          else
            echo "‚ö†Ô∏è Site may still be starting up"
          fi