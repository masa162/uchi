# うちのきろく - 基本設計書 v1.0

**更新日**: 2025年8月10日  
**バージョン**: 1.0  
**プロジェクト**: 家族の思い出共有アプリケーション

---

## 📋 プロジェクト概要

### アプリケーション名
**うちのきろく** - 家族のあたたかい思い出をつづる場所

### 目的・コンセプト
- 家族の日常の大切な思い出を記録・共有
- やさしく親しみやすいUI/UX
- セキュアな認証システムによる安全な情報管理
- マークダウン記法による柔軟な記事作成

### アクセス情報
- **本番URL**: http://160.251.136.92:3000
- **開発環境**: Docker Compose構成
- **リポジトリ**: https://github.com/masa162/uchi

---

## 🏗️ システムアーキテクチャ

### 全体構成図

```
[ユーザー] 
    ↓ HTTPS/HTTP
[nginx] (将来実装予定)
    ↓
[Next.js Application Container]
    ↓ Database Connection
[PostgreSQL Container]
    ↓ Data Persistence
[Docker Volumes]
```

### デプロイ環境の変遷

#### 当初構想 (2025年初期)
```
Frontend: Next.js → Vercel
Database: Supabase (PostgreSQL)
Authentication: NextAuth.js + Supabase Auth
```

#### 現在の構成 (2025年8月実装)
```
Infrastructure: ConoHa VPS (Ubuntu 24.04)
Container: Docker + Docker Compose
Frontend/Backend: Next.js 15.4.5 (統合)
Database: PostgreSQL 16 (Docker Container)
Authentication: NextAuth.js (自前実装)
```

**変更理由**: 
- より柔軟なインフラ制御
- Docker化による環境統一
- フルスタック開発体験の実現

---

## 💻 技術スタック詳細

### フロントエンド技術

#### Core Framework
```
Next.js: 15.4.5
├── App Router (最新アーキテクチャ)
├── React: 18.3.1
├── TypeScript: 5.6.3
└── Node.js: 20.19.4
```

#### スタイリング
```
TailwindCSS: 3.4.17 (v4から移行)
├── daisyUI: 5.0.50 (UIコンポーネント)
├── PostCSS: 8.5.6
├── Autoprefixer: 10.4.21
└── レスポンシブデザイン対応
```

#### 主要ライブラリ
```
react-markdown: Markdown表示
remark-gfm: GitHub Flavored Markdown
rehype-raw: HTML混在サポート
rehype-sanitize: XSS保護
```

### バックエンド技術

#### API Layer
```
Next.js API Routes
├── RESTful API設計
├── Server Actions (実験的機能)
└── Edge Runtime対応
```

#### データベース層
```
PostgreSQL: 16 (Docker)
├── Prisma ORM: 6.13.0
├── スキーマ管理: Prisma Migrate
└── クエリ最適化: Prisma Client
```

#### 認証システム
```
NextAuth.js: 4.24.13
├── Google OAuth 2.0
├── LINE Login
├── Email Magic Link
└── セッション管理: JWT + Database
```

### インフラストラクチャ

#### Container Technology
```
Docker: 28.3.3
├── Multi-stage Build
├── Alpine Linux Base
├── Production Optimization
└── Docker Compose: v2.39.1
```

#### VPS環境
```
Provider: ConoHa VPS
OS: Ubuntu 24.04 LTS
CPU: 共有vCPU
Memory: 共有メモリ
Storage: SSD永続化
Network: 固定IP (160.251.136.92)
```

#### セキュリティ
```
Firewall: UFW
├── SSH: Port 22
├── HTTP: Port 3000
├── 将来HTTPS: Port 443
└── 未使用ポート: 全て拒否
```

---

## 🗄️ データベース設計

### スキーマ構成

#### Users Table
```sql
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  -- Relations
  accounts Account[]
  sessions Session[]
  articles Article[]
}
```

#### Articles Table
```sql
model Article {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  content     String
  description String?
  category    String?
  tags        String[]
  isPublished Boolean  @default(false)
  pubDate     DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  -- Relations
  authorId String
  author   User     @relation(fields: [authorId], references: [id])
  comments Comment[]
  likes    Like[]
}
```

#### Authentication Tables
```sql
-- NextAuth.js 標準テーブル
model Account { ... }
model Session { ... }
model VerificationToken { ... }

-- 拡張機能
model Comment { ... }
model Like { ... }
```

### データ永続化
```
Docker Volume: postgres_data
Backup Strategy: 定期バックアップ (将来実装)
Migration: Prisma Migrate
Seeding: 開発用データ投入
```

---

## 🔐 セキュリティ設計

### 認証フロー

#### Google OAuth
```
1. ユーザー → Google認証画面
2. Google → Callback URL
3. NextAuth.js → Token検証
4. Database → User情報保存
5. Session → JWT発行
```

#### Email Magic Link
```
1. Email入力 → Magic Link送信
2. Email内Link → Token検証
3. NextAuth.js → Session作成
4. Dashboard → ログイン完了
```

### セキュリティ対策
```
XSS Protection: rehype-sanitize
CSRF Protection: NextAuth.js内蔵
SQL Injection: Prisma ORM
Session Security: HTTP-Only Cookie
Environment Variables: Docker Secrets
```

---

## 🎨 UI/UX設計

### デザインシステム

#### カラーパレット
```css
Primary: Green系 (家族の温かさ)
Secondary: クリーム系 (やさしさ)
Accent: 落ち着いた色調
Background: ダークモード対応
```

#### コンポーネント設計
```
daisyUI Components:
├── Button (btn-primary, btn-ghost)
├── Card (記事表示)
├── Form (input, textarea)
├── Modal (確認ダイアログ)
└── Navigation (navbar, sidebar)
```

#### レスポンシブ対応
```css
Mobile: < 768px
Tablet: 768px - 1024px
Desktop: > 1024px
Grid System: TailwindCSS Grid
```

### ユーザビリティ

#### 親しみやすさの演出
```
- 「あいことば」(Password)
- 「うちのきろく」(App Name)  
- 温かいメッセージング
- 直感的なアイコン使用
```

---

## 📁 ディレクトリ構造

### プロジェクト全体
```
uchi/
├── src/app/                 # Next.js App Router
│   ├── api/                 # API Routes
│   ├── auth/                # 認証関連ページ
│   ├── articles/            # 記事関連ページ
│   ├── categories/          # カテゴリページ
│   └── globals.css          # グローバルスタイル
├── prisma/                  # データベース設定
├── public/                  # 静的ファイル
├── docs/                    # プロジェクト文書
├── docker-compose.yml       # Container定義
├── Dockerfile              # Application Image
└── package.json            # 依存関係
```

### API Routes構成
```
/api/
├── auth/                    # NextAuth.js
├── articles/                # 記事CRUD
│   ├── [slug]/             # 個別記事
│   ├── category/[category]/ # カテゴリ別
│   ├── tag/[tag]/          # タグ別
│   └── archive/[yearMonth]/ # アーカイブ
└── test-config/            # 設定確認
```

---

## 🔄 開発・デプロイフロー

### 開発環境
```bash
# ローカル開発開始
git clone https://github.com/masa162/uchi.git
cd uchi
docker-compose up -d     # Database起動
npm run dev             # 開発サーバー起動
```

### 本番デプロイ
```bash
# VPS環境での更新
ssh root@160.251.136.92
cd /var/www/uchi
git pull origin main
npm install             # 依存関係更新
npm run build          # Production Build
npm run start          # 本番サーバー起動
```

### 環境管理
```
Development: .env.local
Production: .env.docker → .env
Testing: .env.test
Docker: docker-compose環境変数
```

---

## ⚡ パフォーマンス設計

### Next.js最適化
```
Static Generation: 可能な箇所で活用
Image Optimization: next/image使用
Code Splitting: 自動最適化
Bundle Analysis: 定期的な監視
```

### データベース最適化
```
Indexing: 主要クエリ対象
Connection Pooling: Prisma管理
Query Optimization: N+1問題回避
Caching Strategy: 将来実装予定
```

### インフラ最適化
```
Docker Multi-stage: Build Size削減
Alpine Linux: 軽量Base Image  
Volume Mount: データ永続化
Health Checks: サービス監視
```

---

## 📊 監視・ログ設計

### アプリケーション監視 (将来実装)
```
Error Tracking: Sentry等の検討
Performance: Core Web Vitals
Analytics: Google Analytics
User Behavior: ヒートマップ等
```

### システム監視
```
Container Health: Docker監視
Resource Usage: CPU/Memory
Database Performance: PostgreSQL監視
Network: 接続状況・レスポンス
```

### ログ管理
```
Application Logs: Next.js Console
Database Logs: PostgreSQL
Access Logs: nginx (将来実装)
Error Logs: 構造化ログ
```

---

## 🚀 拡張予定・ロードマップ

### フェーズ1: 基盤安定化 (完了)
- ✅ Docker環境構築
- ✅ Next.js 15対応
- ✅ 基本機能実装

### フェーズ2: 運用最適化 (進行中)
- [ ] OAuth本番設定
- [ ] SSL/HTTPS化
- [ ] PM2プロセス管理
- [ ] 監視システム

### フェーズ3: 機能拡張 (計画中)
- [ ] 画像アップロード最適化
- [ ] 検索機能強化
- [ ] 通知システム
- [ ] PWA対応

### フェーズ4: AI統合 (検討中)
- [ ] dify AI執事機能
- [ ] 自動タグ付け
- [ ] 内容推奨システム
- [ ] 自然言語検索

---

## 🛠️ 技術的制約・考慮事項

### Next.js 15対応
```
Breaking Changes:
- Promise-based params (対応済み)
- Suspense boundaries (対応済み) 
- App Router移行 (対応済み)
```

### Docker制約
```
Network: Host-Container間の設定
Volume: データ永続化の管理
Resource: メモリ・CPU制限
Security: Container間通信
```

### VPS制約
```
Resource: 共有リソース環境
Scalability: 単一インスタンス
Backup: 手動バックアップ
Monitoring: 基本的な監視
```

---

## 📝 設定ファイル管理

### 主要設定ファイル
```
next.config.ts: Next.js設定
tailwind.config.ts: TailwindCSS設定
postcss.config.js: PostCSS設定
prisma/schema.prisma: DB Schema
docker-compose.yml: Container定義
Dockerfile: Image Build設定
```

### 環境変数管理
```env
# Database
DATABASE_URL=postgresql://...

# NextAuth
NEXTAUTH_SECRET=...
NEXTAUTH_URL=...

# OAuth Providers
GOOGLE_CLIENT_ID=...
GOOGLE_CLIENT_SECRET=...
LINE_CHANNEL_ID=...
LINE_CHANNEL_SECRET=...

# Email
EMAIL_SERVER_HOST=...
EMAIL_SERVER_USER=...
EMAIL_SERVER_PASSWORD=...
```

---

## 💡 技術的意思決定記録

### Vercel → VPS移行理由
1. **制御の柔軟性**: インフラの完全制御
2. **学習価値**: DevOps・運用スキル習得
3. **コスト管理**: 予測可能な固定費
4. **機能拡張性**: 複雑な機能実装対応

### TailwindCSS v4 → v3移行理由
1. **安定性**: lightningcss互換性問題
2. **生産性**: 既存コンポーネントとの親和性
3. **チーム開発**: 標準的な設定での統一
4. **保守性**: 長期的な安定運用

### Docker採用理由
1. **環境統一**: 開発・本番の完全同期
2. **チーム開発**: 環境構築の簡素化
3. **スケーラビリティ**: 将来の拡張対応
4. **保守性**: システムの再現可能性

---

**文書作成日**: 2025年8月10日  
**次回更新予定**: 機能拡張・AI統合検討後  
**承認**: 開発チーム**