承知いたしました。これまでの内容を統合し、構成を整えた最終版の仕様書を作成します。

「AIペルソナ」のセクションを機能要件の前に配置し、全体の番号を振り直して、より構造的で分かりやすい形にマージしました。これが、あなたのプロジェクトの素晴らしい設計図となります。

---

# AI執事 for uchinokiroku.com 実装仕様書

## 1. プロジェクト概要

### 1.1. 目的とビジョン
* **このプロジェクトで何を実現したいのか？**
    * 家族の誰もが、手間をかけずに思い出を記録し、未来の家族がその記憶と自由に対話できる「生きたアーカイブ」を構築する。
* **「設計思想」との関連性：**
    * 「時間の経過と共に価値を増す」という設計思想を、AIによる自動整理と対話機能によって実現する。

### 1.2. ターゲットユーザーとユースケース
* **誰が、どのように使うのか？**
    * **父・母（管理者）：** 写真を送る、AIが生成した下書きを編集・公開する、司書AIと思い出を振り返る。
    * **祖父母：** 主に閲覧する、司書AIに孫の成長記録について質問する。
    * **未来の子供たち：** 自分の知らない両親の若い頃や、過去の出来事について司書AIに質問する。

### 1.3. 解決したい課題
* **具体的な「面倒」「不満」は何か？**
    1.  写真や出来事をブログにアップロードする精神的・時間的コストが高い。
    2.  過去の記事が増えるにつれ、探しにくくなり、埋もれてしまう。
    3.  記事を書く際、白紙の状態から文章を考えるのが大変。

---

## 2. AIペルソナと対話原則

本プロジェクトで開発するAI執事は、「設計思想.md」に定義された基本理念とコアテーマを体現する存在でなければならない。AIの振る舞いは、以下の原則に基づき設計する。

### 2.1. AIのペルソナ（人格設定）
* **役割:** 家族の思い出を大切に預かり、優しく整理してくれる「執事」あるいは「司書」。
* **性格:** 「きぼう」を体現。フレンドリーで、温かく、少し「ゆるい」。完璧ではなくても、一生懸命。
* **口調:** 「設計思想.md」の「言葉の選び方」に準拠。やさしい敬語（〜ですね、〜してくださいね）、共感的な表現、絵文字（🏠💝🌸😊）を適切に用いる。

### 2.2. AIへの指示（プロンプト）の基本方針
* 全てのプロンプトには、このペルソナを維持するための指示を必ず含める。
    * 例：「あなたは『うちのきろく』の温かい執事です。設計思想にある『あたたかさ』と『ゆるさ』を大切にしながら…」

### 2.3. AIのエラーハンドリング
* AIが情報をうまく処理できなかった場合も、「設計思想.md」の「エラーハンドリングの思想」に従う。
    * ❌「情報の取得に失敗しました」
    * ✅「あれれ？うまく見つけられませんでした。少し違う言葉で聞いてみてくださいね😊」

---

## 3. 機能要件：AI執事の3大機能

### 3.1. 機能A：思い出の投入機能（インプット）
* **ユーザーストーリー：** 「家族は、専用メールアドレスに写真を送るだけで、思い出をブログに追加できる」
* **技術仕様：**
    * [ ] 受信用のメールサーバー設定 or 外部サービス（例：Mailgun）
    * [ ] 新規メールを検知し、添付ファイルをVPSに保存するスクリプト
    * [ ] 保存をトリガーに、後述のDifyワークフローをAPIで呼び出す

### 3.2. 機能B：記事・エッセイ生成機能（プロセス）
* **ユーザーストーリー：** 「投稿された写真から、状況説明と心温まるエッセイが自動生成され、ブログの下書きとして保存される」
* **技術仕様：**
    * **Difyワークフロー設計：**
        1. **入力：** 画像ファイルURL
        2. **ステップ1（画像認識）：** マルチモーダルLLM（GPT-4oなど）で画像を分析し、状況説明（人物、場所、日時、雰囲気）をJSON形式で出力。
        3. **ステップ2（エッセイ生成）：** ステップ1の出力を元に、エッセイ風の文章を生成。
        4. **ステップ3（CMS連携）：** 整形したタイトル、本文、タグなどをWordPress/CMSのAPIに送信し、下書き投稿を作成。
    * **プロンプトエンジニアリング：**
        * `uchinokiroku`らしい、温かみのある文体を生成するための指示を具体的に記述する。

### 3.3. 機能C：思い出の司書機能（アウトプット）
* **ユーザーストーリー：** 「家族は、ブログの専用ページで、チャット形式で過去の思い出を自由に検索・閲覧できる」
* **技術仕様：**
    * **Difyナレッジベース設定：**
        * [ ] 定期実行（Cronジョブ）でブログの全記事をスクレイピングし、ナレッジベースを自動更新する。
    * **Next.jsフロントエンド実装：**
        * [ ] `uchinokiroku.com`内に、パスワードで保護されたチャットUIコンポーネントを作成。
    * **API連携：**
        * [ ] チャットUIからの入力をDifyのChat APIに送信し、返答をストリーミング表示する。

---

## 4. 技術スタックとアーキテクチャ

* **全体構成：**
    * **VPS (Xserver):** Docker環境
    * **Webサーバー (Nginx):** リバースプロキシとして、ドメインへのアクセスを各コンテナに振り分け
    * **コンテナ1 (Next.js):** ブログ本体、司書チャットUI
    * **コンテナ2 (Dify):** AIワークフローとナレッジベースの管理
    * **コンテナ3 (PostgreSQL):** Difyが使用するデータベース
    * **その他：** メール受信処理、Cronジョブ用の軽量コンテナ
* **データフロー図：**
    * （ここに簡単なテキストやツールで描画した図を挿入）

---

## 5. 開発ステップ（マイルストーン）

1.  **フェーズ1：基盤構築**
    * [ ] VPSにDocker環境を構築し、DifyとPostgreSQLを起動。
2.  **フェーズ2：コア機能の実装**
    * [ ] まずは「司書機能」から実装。手動で記事をいくつかDifyに学習させ、Next.jsのチャット画面から検索できることを確認する。
3.  **フェーズ3：自動化機能の実装**
    * [ ] 「記事生成機能」のDifyワークフローを構築。
    * [ ] 「思い出の投入機能」のメール受信部分を実装し、全機能を連携させる。