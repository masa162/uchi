# 監視システム運用ガイド

**作成日**: 2025年8月13日  
**目的**: うちのきろく監視・通知システムの運用方法

---

## 🔍 監視システム概要

### **監視対象**
1. **Webサイト応答**: https://uchinokiroku.com
2. **データベース接続**: PostgreSQL状態確認
3. **認証API**: NextAuth.js動作確認
4. **VPSシステム**: プロセス・リソース監視

### **監視頻度**
- **GitHub Actions**: 5分間隔
- **VPS cron**: 5分間隔
- **手動確認**: 随時可能

---

## 🛠️ セットアップ手順

### **1. VPS側監視設定**
```bash
# VPS上で実行
cd /var/www/uchi
chmod +x scripts/setup-monitoring.sh
./scripts/setup-monitoring.sh
```

### **2. GitHub Actions確認**
- `.github/workflows/monitoring.yml` が自動実行
- Actionsタブで監視結果確認可能

### **3. ヘルスチェックAPI確認**
```bash
# 基本ヘルスチェック
curl https://uchinokiroku.com/api/health

# データベースチェック
curl https://uchinokiroku.com/api/health/db

# 認証チェック
curl https://uchinokiroku.com/api/health/auth
```

---

## 📊 監視項目詳細

### **Webサイト監視**
- **チェック内容**: HTTP応答確認
- **正常条件**: 200 OK, 15秒以内
- **失敗条件**: タイムアウト・エラーレスポンス

### **データベース監視**
- **チェック内容**: PostgreSQL接続・クエリ実行
- **正常条件**: 接続成功・レスポンス10秒以内
- **失敗条件**: 接続エラー・タイムアウト

### **認証API監視**
- **チェック内容**: NextAuth設定・セッション機能
- **正常条件**: 設定完了・API応答正常
- **失敗条件**: 設定不備・API エラー

### **VPSシステム監視**
- **プロセス**: Next.jsプロセス生存確認
- **ディスク**: 使用率80%で警告、90%でアラート
- **メモリ**: 使用率80%で警告、90%でアラート

---

## 🚨 アラート・通知

### **現在の通知方法**
- **GitHub Actions**: 実行ログでステータス確認
- **VPS ログ**: `/var/log/uchi-health.log`
- **アラートファイル**: `/tmp/uchi-alerts.log`

### **今後実装予定**
- **Slack通知**: チャンネルへの自動通知
- **メール通知**: 管理者へのメール送信
- **復旧通知**: 問題解決時の通知

---

## 🔧 運用コマンド

### **ログ確認**
```bash
# ヘルスチェックログ
tail -f /var/log/uchi-health.log

# アラートログ
tail -f /tmp/uchi-alerts.log

# 最新50件のログ
tail -50 /var/log/uchi-health.log
```

### **手動ヘルスチェック**
```bash
# 詳細ログ付き実行
/var/www/uchi/scripts/health-check.sh --verbose

# 静音実行
/var/www/uchi/scripts/health-check.sh
```

### **cron確認・設定**
```bash
# 現在のcron設定確認
crontab -l

# cron実行履歴確認
grep CRON /var/log/syslog | tail -10
```

### **GitHub Actions手動実行**
1. GitHub → Actions
2. "🔍 うちのきろく 監視システム"
3. "Run workflow"

---

## 📈 パフォーマンス監視

### **レスポンス時間基準**
- **良好**: 3秒未満
- **許容**: 3-5秒
- **問題**: 5秒以上

### **リソース使用率基準**
- **正常**: 80%未満
- **警告**: 80-90%
- **危険**: 90%以上

---

## 🛠️ トラブルシューティング

### **よくある問題**

#### Webサイト応答なし
```bash
# プロセス確認
ps aux | grep next

# 手動再起動
cd /var/www/uchi
pkill -f next
nohup ./start-with-env.sh > restart.log 2>&1 &
```

#### データベース接続エラー
```bash
# PostgreSQL状態確認
sudo systemctl status postgresql

# データベース接続テスト
cd /var/www/uchi
npx prisma db execute --stdin <<< "SELECT 1;"
```

#### 認証API エラー
```bash
# 環境変数確認
cd /var/www/uchi
grep -E "NEXTAUTH|GOOGLE|LINE" .env

# Next.js再起動
pkill -f next
nohup ./start-with-env.sh > restart.log 2>&1 &
```

### **緊急時対応**
1. **即座確認**: `curl https://uchinokiroku.com`
2. **ログ確認**: `tail -50 /var/log/uchi-health.log`
3. **プロセス確認**: `ps aux | grep next`
4. **リソース確認**: `free -h && df -h`
5. **再起動**: 必要に応じてアプリケーション再起動

---

## 📋 定期保守

### **週次確認事項**
- [ ] アラートログ確認
- [ ] ディスク・メモリ使用量確認
- [ ] レスポンス時間確認
- [ ] GitHub Actions実行履歴確認

### **月次確認事項**
- [ ] ログファイルローテーション
- [ ] 監視スクリプト更新確認
- [ ] 通知システム動作確認
- [ ] パフォーマンストレンド分析

---

**🔍 監視システムで安定運用を実現！**