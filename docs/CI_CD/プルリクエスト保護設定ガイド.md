# プルリクエスト保護設定ガイド

**目的**: mainブランチへの直接プッシュを防止し、CI/CDパイプラインを通過したコードのみマージ可能にする

---

## 🛡️ ブランチ保護ルール設定

### 手動設定手順:

#### 1. GitHub設定画面にアクセス
```
https://github.com/masa162/uchi/settings/branches
```

#### 2. Branch protection rule追加
1. **"Add rule"** をクリック
2. **Branch name pattern**: `main`
3. 以下のオプションを有効化:

### 📋 推奨保護設定

#### ✅ **基本保護**
- [ ] **Restrict pushes that create files larger than 100MB**
- [x] **Require a pull request before merging**
  - [x] Require approvals: **1**
  - [x] Dismiss stale PR approvals when new commits are pushed
  - [x] Require review from code owners (オプション)

#### ✅ **CI/CD統合**
- [x] **Require status checks to pass before merging**
  - [x] Require branches to be up to date before merging
  - 必要なステータスチェック:
    - `lint-and-type-check`
    - `build-test` 
    - `test`
    - `ci-status`

#### ✅ **管理者保護**
- [x] **Restrict pushes that create files larger than 100MB**
- [ ] **Allow force pushes** (緊急時のみ)
- [ ] **Allow deletions** (緊急時のみ)

---

## 🔄 プルリクエスト開発フロー

### 開発者向けワークフロー:

#### 1. 機能ブランチ作成
```bash
git checkout -b feature/新機能名
```

#### 2. 開発・コミット
```bash
git add .
git commit -m "feat: 新機能の実装"
```

#### 3. プッシュ・PR作成
```bash
git push origin feature/新機能名
```

#### 4. CI自動実行
- TypeScript型チェック
- Lint検証
- ビルドテスト
- セキュリティチェック

#### 5. レビュー・マージ
- CI成功後、PR承認
- mainブランチにマージ
- 自動デプロイ実行

---

## 🚨 緊急時の対応

### 本番障害時のホットフィックス:

#### Option A: 緊急PR (推奨)
```bash
git checkout -b hotfix/緊急修正
# 修正作業
git push origin hotfix/緊急修正
# 緊急PR作成・即座レビュー・マージ
```

#### Option B: 直接プッシュ (最終手段)
1. 一時的にブランチ保護無効化
2. 直接mainプッシュ
3. 即座にブランチ保護再有効化

---

## 📊 CI/CDパイプライン統合状況

### 現在のワークフロー:

#### 🏠 CI Pipeline (.github/workflows/ci.yml)
- **トリガー**: PR作成・push to main
- **ジョブ**: lint-and-type-check → build-test + test → ci-status
- **セキュリティ**: 秘密情報スキャン (PRのみ)

#### 🚀 Deploy Pipeline (.github/workflows/deploy.yml)  
- **トリガー**: push to main (CI成功後)
- **対象**: VPS (160.251.136.92)
- **プロセス**: コード更新 → ビルド → ヘルスチェック

---

## ✅ 設定確認チェックリスト

### ブランチ保護設定:
- [ ] main ブランチ保護ルール作成済み
- [ ] PR必須設定有効
- [ ] CI ステータスチェック必須設定
- [ ] 承認者1名必須設定

### CI/CD設定:
- [ ] GitHub Actions ワークフロー動作確認
- [ ] GitHub Secrets (VPS_SSH_KEY) 設定済み
- [ ] VPS自動デプロイテスト成功

### 開発フロー:
- [ ] 機能ブランチでの開発確認
- [ ] PRテンプレート作成 (オプション)
- [ ] レビューガイドライン策定 (オプション)

---

## 🔧 トラブルシューティング

### CI失敗パターン:

#### TypeScript エラー
```bash
npm run type-check
# エラー修正後再コミット
```

#### ビルドエラー
```bash
npm run build
# 環境変数・依存関係確認
```

#### セキュリティエラー
```bash
# 秘密情報マスク化
find . -name "*.md" -exec sed -i 's/GOCSPX-[^"]*/"[MASKED]"/g' {} \;
```

### デプロイ失敗時:
1. VPS SSH接続確認
2. GitHub Secrets設定確認  
3. VPS側ログ確認: `/var/www/uchi/deploy.log`