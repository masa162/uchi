# うちのきろく - 新システム移行計画書

## 1. プロジェクト概要

### 1.1. 現行システム
- **フレームワーク:** Astro
- **ホスティング:** Netlify
- **コンテンツ管理:** Markdownファイル (Gitリポジトリ経由)
- **画像管理:** Lolipopレンタルサーバー (FTP経由)
- **認証:** Basic認証 (単一のID/PASS)
- **機能:** 静的サイト、ブログ形式、検索機能、エッセイカテゴリ、著者表示、ライト/ダークモード切り替え

### 1.2. 新システム目標
- **目的:** 家族全員がコンテンツ（記事、写真、コメント）を投稿・共有できる動的なプラットフォームへの進化。
- **コンセプト:** 「アーカイブ」 - 10年、20年後へと家族の思い出写真、エッセイを伝え、保管する。
- **主要機能:** ユーザー認証、記事投稿（Markdown対応）、画像投稿、コメント機能、いいね機能。
- **認証方式:** Supabase Authentication を利用。
    - **初回アクセス:**
        - サイトトップページに「あいことば」入力画面を設置。
        - 正しい「あいことば」を入力したユーザーのみ、ユーザー登録/ログイン画面へ進める。
        - 「あいことば」はクライアントサイドでチェックし、カジュアルなアクセス制限として機能させる。
    - **ユーザー登録/ログイン:**
        - ID/PASSでのサインアップ（SupabaseのEmail Signupsを有効化）。
        - Google/GitHubなどのOAuth認証（Open Authorization）を有効化。
        - 既存ユーザーはID/PASSまたはOAuthでサインイン。
    - **セッション管理:** ログイン後はCookieによりセッションを維持し、再ログインの手間を省く。
    - **セキュリティと管理:**
        - データベースのRow Level Security (RLS) を活用し、認証済みユーザーのみがコンテンツにアクセス・投稿できるよう厳密に制御する。
        - 管理者（中山様）はSupabaseの認証ログを定期的に確認し、不審なユーザー登録やログインがないか監視する。

## 2. 新システム技術スタック

- **フロントエンドフレームワーク:** Next.js (React)
- **バックエンドサービス:** Supabase (PostgreSQL DB, 認証, ストレージ)
- **ホスティング:** Vercel

## 3. コンテンツ管理とワークフロー

### 3.1. 記事コンテンツ
- **形式:** Markdown形式を維持。
- **投稿ワークフロー:**
    - **管理者・閲覧者共通:** Webブラウザ上のフォームから記事を投稿。
    - フォームにはMarkdownエディタを組み込み、リアルタイムプレビューを可能にする。
    - 投稿された記事はSupabaseのデータベースに格納される。

### 3.2. 画像コンテンツ
- **ユーザー投稿画像:**
    - **格納場所:** Supabase Storage
    - **理由:** Supabase Authenticationとの連携、S3互換による将来的な柔軟性、CDNによる高速配信。
    - **コスト:** Supabaseの無料枠で運用開始し、必要に応じて有料プランへ移行。
- **管理者（中山様）投稿画像（既存のフォトギャラリーなど）:**
    - **格納場所:** Lolipopレンタルサーバー (既存のFTPワークフローを維持)
    - **理由:** 既存資産の活用、コスト効率の維持、大容量画像の管理。
    - **Next.jsでの表示:** Markdown記事内に記載されたLolipopの画像URLをそのまま表示する。

## 4. データベーススキーマ (初期案)

### 4.1. `articles` テーブル
- `id` (UUID, Primary Key)
- `created_at` (timestamp with timezone, default now())
- `title` (text)
- `slug` (text, Unique)
- `description` (text, Optional)
- `content` (text, Markdown形式の本文)
- `pub_date` (date)
- `author_id` (UUID, Foreign Key to `profiles` table)
- `hero_image_url` (text, Optional, LolipopまたはSupabase StorageのURL)
- `tags` (text[], Optional)
- `category` (text, Optional, 例: 'essay')
- `is_published` (boolean, Default: true)

### 4.2. `profiles` テーブル (ユーザー情報)
- `id` (UUID, Primary Key, Supabase Authの`users.id`と連携)
- `created_at` (timestamp with timezone, default now())
- `username` (text, Unique)
- `avatar_url` (text, Optional)
- `full_name` (text, Optional)

### 4.3. `comments` テーブル
- `id` (UUID, Primary Key)
- `created_at` (timestamp with timezone, default now())
- `article_id` (UUID, Foreign Key to `articles` table)
- `user_id` (UUID, Foreign Key to `profiles` table)
- `content` (text)

### 4.4. `likes` テーブル
- `id` (UUID, Primary Key)
- `created_at` (timestamp with timezone, default now())
- `article_id` (UUID, Foreign Key to `articles` table)
- `user_id` (UUID, Foreign Key to `profiles` table)

## 5. 開発フェーズ (初期)

1.  **Next.jsプロジェクトの初期化:** TypeScript, Tailwind CSS, ESLint 設定。
2.  **Supabaseプロジェクトのセットアップ:** DB, 認証, ストレージの初期設定。
    - **認証設定:** 公開サインアップを無効化し、管理者によるユーザー作成/招待方式を採用。
3.  **基本的なコンテンツ表示:** Supabaseから記事をフェッチし、Next.jsで表示（Markdownレンダリング含む）。
4.  **ユーザー認証:** ログイン/ログアウト/サインアップ機能の実装。
5.  **記事投稿機能:** 認証済みユーザーによる記事投稿フォームの実装（Markdownエディタ、画像アップロード含む）。

## 6. コンテンツ移行

- **既存記事:** 約10記事と数が少ないため、新しいシステムでの記事追加フローの動作確認を兼ねて**手動で移行**する。
- **画像:** 既存記事の画像はLolipopレンタルサーバーに絶対パスで記述されているため、記事本文のコピペで対応可能。

## 7. UI/UX デザイン方針

- **現行サイトの踏襲:** 現行のAstroサイト (`https://uchinokiroku.com/`) の見た目とユーザー体験（UI/UX）を基本的に踏襲する。
- **デザインシステム:** Tailwind CSS と DaisyUI を引き続き使用し、既存のテーマカラー、フォント、コンポーネントスタイルを再現する。
- **レイアウト:** サイドバー付きのメインコンテンツレイアウトを維持する。
- **機能の再現:** 検索機能、エッセイカテゴリ表示、著者表示、ライト/ダークモード切り替えなど、現行サイトで実装済みのUI/UXを新しいシステムでも再現する。
- **特に重視するUI/UX要素:**
    - モバイルでのハンバーガーメニュー
    - 月別アーカイブ機能
    - タグ機能
    - 検索ボックス
- **モバイルファースト:** 引き続きモバイルファーストのアプローチを徹底し、スマートフォンでの閲覧・操作性を最適化する。

## 8. SEO方針

- **目的:** 「うちのきろく」というサイト名での検索における発見性を確保する。
- **コンテンツの非公開性:** 家族のクローズドコミュニティであるため、記事などのコンテンツ自体は検索エンジンによるインデックスを不要とする。
- **実現方法:**
    - サイトのトップページ（「あいことば」入力ページ）の`<title>`タグと`<meta name="description">`タグに「うちのきろく」を含める。
    - コンテンツは「あいことば」とSupabase Authenticationによる認証ゲートの向こう側に配置されるため、検索エンジンのクローラーはコンテンツにアクセスできず、自然とインデックスされない。
    - Vercelにデプロイされたサイトは公開されるが、認証機能によりコンテンツは保護される。

## 9. デプロイ戦略

- **Vercelによる自動デプロイ:**
    - GitHubリポジトリとVercelを連携させ、コードの変更（`main`ブランチへのプッシュなど）をトリガーに自動でビルド・デプロイを行う。
    - プルリクエストごとにプレビューURLが生成され、本番デプロイ前に変更を確認できる。
- **Supabaseの管理:**
    - データベース、認証、ストレージといったバックエンドはSupabaseがマネージドサービスとして提供するため、デプロイやインフラ管理はSupabase側で行われる。
- **運用フェーズでのデプロイ頻度:**
    - コンテンツの追加・編集はWebブラウザ経由でSupabaseデータベースに直接行われるため、サイトのコードベースに変更がない限り、デプロイは発生しない。
    - 機能追加、UI/UX改善、バグ修正など、コードベースに変更があった場合のみデプロイを行う。
- **環境変数:** SupabaseのAPIキーなどはVercelのプロジェクト設定で環境変数として安全に管理する。

## 10. 今後の機能拡張 (Roadmap)

- サイト内検索機能の強化 (より高度な検索オプション)
- コメント機能の強化 (返信機能、編集・削除機能)
- ユーザープロフィールページの作成 (各ユーザーの投稿一覧など)
- 通知機能 (新しいコメント、いいねなど)
- 管理者ダッシュボード (ユーザー管理、コンテンツ管理の簡易化)

## 11. エラーハンドリング

- **ユーザーへの表示:** ユーザー操作に起因するエラー（例: 入力値の不足、認証失敗）は、ユーザーインターフェース上で分かりやすくフィードバックする。
- **システムエラー:** 予期せぬシステムエラー（例: データベース接続エラー）は、ユーザーには一般的なエラーメッセージを表示し、詳細はVercelやSupabaseのログに記録する。
- **ログ監視:** 管理者（中山様）はVercelおよびSupabaseのログを定期的に確認し、エラーの発生状況を把握する。

---