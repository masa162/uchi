# F004: カテゴリ→タグ統合設計書

**作成日**: 2025年8月15日  
**機能ID**: F004  
**優先度**: 🟡 中優先度  
**目的**: カテゴリとタグを統合し、より柔軟で一貫性のある分類システムを実現

---

## 📋 設計概要

### **統合アプローチ: カテゴリ→スペシャルタグ化**

カテゴリを削除し、既存カテゴリを「プライマリタグ」として統合する。

```
現在: category: "家族" + tags: ["思い出", "2025"]
統合後: tags: ["家族", "思い出", "2025"] (家族=プライマリタグ)
```

---

## 🎯 統合戦略

### **Phase 1: データ構造変更**

#### **Before (現在)**
```typescript
interface Article {
  category?: string        // 単一選択
  tags: string[]          // 複数選択
}
```

#### **After (統合後)**
```typescript
interface Article {
  // category フィールドを削除
  tags: string[]          // プライマリタグ + セカンダリタグ
  primaryTag?: string     // メインカテゴリ的な役割（オプション）
}
```

### **Phase 2: プライマリタグシステム**

#### **プライマリタグ（元カテゴリ）**
```typescript
const PRIMARY_TAGS = [
  { value: '家族', label: '👨‍👩‍👧‍👦 家族', color: 'blue' },
  { value: '旅行', label: '✈️ 旅行', color: 'green' },
  { value: '料理', label: '🍳 料理', color: 'orange' },
  { value: '子育て', label: '👶 子育て', color: 'pink' },
  { value: 'イベント', label: '🎉 イベント', color: 'purple' },
  { value: '日記', label: '📝 日記', color: 'gray' },
  { value: '健康', label: '💪 健康', color: 'red' },
  { value: '趣味', label: '🎨 趣味', color: 'indigo' },
  { value: 'その他', label: '📂 その他', color: 'slate' }
]
```

#### **セカンダリタグ（既存タグ）**
- 自由入力
- 過去の使用履歴からサジェスト
- 検索・フィルタリング対応

---

## 🛠️ 実装計画

### **Step 1: データベースマイグレーション**

```sql
-- 1. 既存カテゴリをタグに統合
UPDATE articles 
SET tags = CASE 
  WHEN category IS NOT NULL AND category != ''
  THEN array_prepend(category, tags)
  ELSE tags
END
WHERE category IS NOT NULL;

-- 2. カテゴリフィールドを削除
ALTER TABLE articles DROP COLUMN category;
```

### **Step 2: UIコンポーネント更新**

#### **記事作成ページ**
```tsx
// 現在のカテゴリ選択 + タグ入力を統合
<TagSelector 
  primaryTags={PRIMARY_TAGS}      // プライマリタグ選択
  selectedTags={selectedTags}     // 選択済みタグ
  suggestions={suggestedTags}     // サジェストタグ
  onTagsChange={setSelectedTags}
  maxPrimaryTags={1}              // プライマリタグは1つまで
/>
```

#### **記事表示**
```tsx
// タグ表示でプライマリ・セカンダリを区別
<TagDisplay 
  tags={article.tags}
  primaryTags={PRIMARY_TAGS}
  className="flex flex-wrap gap-2"
/>
```

### **Step 3: ルーティング統合**

#### **Before**
```
/categories/家族 → カテゴリ別ページ
/tags/思い出     → タグ別ページ
```

#### **After**
```
/tags/家族       → 統合タグページ（プライマリタグ）
/tags/思い出     → 統合タグページ（セカンダリタグ）
```

---

## 🎨 UI/UX設計

### **プライマリタグの特別表示**

```tsx
// プライマリタグは大きく、色付きで表示
<span className="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
  👨‍👩‍👧‍👦 家族
</span>

// セカンダリタグは小さく、グレーで表示
<span className="inline-flex items-center px-2 py-1 rounded-full text-xs bg-gray-100 text-gray-600">
  思い出
</span>
```

### **記事作成フロー**

1. **プライマリタグ選択** (必須ではないが推奨)
   - 9つの定義済みタグから選択
   - 1つまで選択可能

2. **セカンダリタグ追加** 
   - 自由入力
   - サジェスト機能
   - 複数選択可能

### **検索・フィルタリング**

```tsx
// 統合検索バー
<TagSearch 
  placeholder="タグで検索（例：家族、思い出、2025）"
  primaryTags={PRIMARY_TAGS}
  allTags={allUsedTags}
  onSearch={handleTagSearch}
/>
```

---

## 📊 データ移行戦略

### **既存データの処理**

1. **カテゴリ有りの記事**
   ```sql
   -- カテゴリ "家族" + タグ ["思い出", "2025"]
   -- → タグ ["家族", "思い出", "2025"]
   ```

2. **カテゴリ無しの記事**
   ```sql
   -- タグ ["思い出", "2025"] のまま
   -- プライマリタグなしとして扱う
   ```

3. **重複除去**
   ```sql
   -- カテゴリ "家族" + タグ ["家族", "思い出"] の場合
   -- → タグ ["家族", "思い出"] (重複除去)
   ```

### **移行後の検証**

```sql
-- 移行前後のデータ整合性確認
SELECT 
  COUNT(*) as total_articles,
  COUNT(CASE WHEN '家族' = ANY(tags) THEN 1 END) as family_tagged,
  AVG(array_length(tags, 1)) as avg_tags_per_article
FROM articles;
```

---

## 🔧 技術実装詳細

### **Prismaスキーマ更新**

```prisma
model Article {
  id          String    @id @default(cuid())
  // ... 他のフィールド
  tags        String[]  // カテゴリを統合
  // category フィールドを削除
  
  @@map("articles")
}
```

### **TypeScript型定義**

```typescript
// タグ関連の型定義
interface Tag {
  value: string
  label?: string
  isPrimary?: boolean
  color?: string
  count?: number
}

interface TaggedArticle {
  // ... 他のフィールド
  tags: string[]
  primaryTag?: string  // 最初のプライマリタグ
}
```

### **API更新**

```typescript
// /api/articles/tags → 統合タグエンドポイント
// /api/articles/category/[category] → /api/articles/tag/[tag]
```

---

## ✅ 成功指標

### **機能的指標**
- [ ] カテゴリ→タグ移行率: 100%
- [ ] データ損失: 0件
- [ ] 検索機能: プライマリ・セカンダリタグ両対応

### **ユーザビリティ指標**
- [ ] タグ選択時間: 30秒以内
- [ ] タグ検索精度: 90%以上
- [ ] ユーザー満足度: 8/10以上

### **パフォーマンス指標**
- [ ] タグページ表示速度: 2秒以内
- [ ] タグ検索応答時間: 1秒以内

---

## 🚨 リスク・注意事項

### **データ移行リスク**
- 既存URL (`/categories/*`) のリダイレクト必須
- SEO影響を最小化するため段階的移行

### **ユーザビリティリスク**
- カテゴリ慣れしたユーザーへの説明
- プライマリタグの概念理解

### **技術的リスク**
- タグ数増加によるパフォーマンス影響
- 検索クエリの複雑化

---

## 📅 実装スケジュール

### **Phase 1: 基盤準備 (1-2日)**
- データベースマイグレーション
- 基本型定義・API更新

### **Phase 2: UI実装 (2-3日)**
- タグ選択コンポーネント
- 記事表示更新

### **Phase 3: 統合・テスト (1日)**
- データ移行実行
- 機能テスト・デプロイ

---

**責任者**: Claude Code Assistant  
**レビュー**: プロジェクト管理者  
**実装予定**: 2025年8月16-20日