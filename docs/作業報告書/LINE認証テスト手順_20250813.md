# LINE Login認証テスト手順

**作成日**: 2025年8月13日 10:10  
**実施環境**: https://uchinokiroku.com  
**目的**: LINE Login修正版の動作確認

---

## 🎯 テスト準備完了事項

### ✅ **システム状態**
- VPS環境: 完全クリーンアップ済み
- Next.js: ポート3000で正常稼働中
- LINE Provider設定: 修正版適用済み
- デバッグページ: デプロイ完了

### ✅ **修正内容**
1. **IDトークン署名アルゴリズム**: `id_token_signed_response_alg: "HS256"`
2. **認証スコープ**: `scope: "profile openid email"`
3. **デバッグログ**: LINE認証専用ログ出力
4. **専用テストページ**: `/auth/line-debug`

---

## 🔧 テスト手順

### **手順1: LINE Debug ページでのテスト**

1. **アクセス**: https://uchinokiroku.com/auth/line-debug
2. **環境変数チェック**: 「環境変数チェック」ボタンをクリック
   - LINE_CHANNEL_ID, LINE_CHANNEL_SECRET の設定確認
3. **LINE認証テスト**: 「LINE Login テスト」ボタンをクリック
   - LINE認証画面への遷移確認
   - コールバック処理の成功確認

### **手順2: メインページでのテスト**

1. **アクセス**: https://uchinokiroku.com/auth/signin
2. **LINE Login**: 緑色の「LINEでログイン」ボタンをクリック
3. **認証フロー**: 
   - LINE認証画面での認証実行
   - コールバック後のログイン成功確認

### **手順3: デバッグ情報の確認**

**ブラウザ開発者ツール**:
- F12キーでコンソールを開く
- LINE認証実行時のログを確認:
  ```
  NextAuth Debug: LINE Profile: [プロファイル情報]
  LINE SignIn - User: [ユーザー情報]
  LINE SignIn - Account: [アカウント情報]
  ```

**VPSログ確認**（技術者向け）:
```bash
ssh -i "/path/to/key.pem" root@160.251.136.92
cd /var/www/uchi
tail -f startup.log
```

---

## 🎯 期待される結果

### **成功パターン**
1. **LINE認証画面**: LINEのOAuth画面が正常表示
2. **認証完了**: ユーザー情報取得成功
3. **セッション作成**: ログイン状態の維持
4. **リダイレクト**: メインページまたはダッシュボードへの遷移

### **デバッグログ（成功時）**
```
NextAuth Debug: LINE Profile: {
  sub: "U1234567890abcdef",
  name: "ユーザー名",
  picture: "https://profile.line-scdn.net/..."
}
LINE SignIn - User: { ... }
```

---

## 🚨 エラーパターンと対処

### **よくあるエラー**

1. **`OAuthCallback Error`**
   - 原因: コールバックURL不一致
   - 対処: LINE Developers Console設定確認

2. **`Profile missing sub (user ID)`**
   - 原因: LINE プロファイル情報取得失敗
   - 対処: スコープ設定確認

3. **`OAuthCreateAccount Error`**
   - 原因: データベース接続問題
   - 対処: 環境変数・DB接続確認

### **トラブルシューティング**

**エラー発生時の確認事項**:
1. ブラウザコンソールのエラーメッセージ
2. LINE Developers Console の設定
3. VPS上のログファイル内容
4. 環境変数の正確性

---

## 📊 テスト結果記録

### **テスト実施者記入欄**

**実施日時**: ___________  
**実施者**: ___________  

**結果**:
- [ ] ✅ LINE認証画面表示: 成功 / 失敗
- [ ] ✅ 認証完了: 成功 / 失敗  
- [ ] ✅ ログイン状態: 成功 / 失敗
- [ ] ✅ 全体評価: 成功 / 失敗

**エラー内容**（失敗の場合）:
```
[エラー詳細をここに記入]
```

**特記事項**:
```
[その他気づいた点があれば記入]
```

---

## 🔄 次回改善項目

テスト結果に基づき、以下の改善を検討:

1. **認証エラー**: 設定の再確認・修正
2. **UX改善**: エラーメッセージの改善
3. **パフォーマンス**: 認証速度の最適化
4. **セキュリティ**: 認証フローの強化

---

**作成者**: Claude Code Assistant  
**更新日**: 2025年8月13日 10:10  
**ステータス**: 🟢 テスト準備完了